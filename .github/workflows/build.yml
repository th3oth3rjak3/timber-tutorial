name: Build Game

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  # -----------------------------
  # Windows
  # -----------------------------
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Package
        run: |
          mkdir timber-windows
          cp build/bin/Release/timber.exe timber-windows/
          cp -r graphics sounds fonts timber-windows/
          cp build/_deps/sfml-build/lib/Release/*.dll timber-windows/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: timber-windows
          path: timber-windows/

  # -----------------------------
  # Linux
  # -----------------------------
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev \
            libudev-dev libgl1-mesa-dev libopenal-dev \
            libvorbis-dev libflac-dev libfreetype6-dev \
            curl

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Build Linux AppImage
        run: bash scripts/package-linux.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: timber-linux
          path: Timber-x86_64.AppImage

  # -----------------------------
  # macOS
  # -----------------------------
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Package
        run: |
          mkdir timber-macos
          cp build/bin/timber timber-macos/
          cp -r graphics sounds fonts timber-macos/
          # Create a convenience run script
          echo '#!/bin/bash' > timber-macos/run.sh
          echo 'cd "$(dirname "$0")"' >> timber-macos/run.sh
          echo './timber' >> timber-macos/run.sh
          chmod +x timber-macos/run.sh
          chmod +x timber-macos/timber

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: timber-macos
          path: timber-macos/
